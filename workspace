#!/bin/bash
set -euo pipefail
trap 'echo "âŒ Error on line $LINENO" >&2; exit 1' ERR

VERSION=0.2.0
VERBOSE="${VERBOSE:-false}"

# Decide what the "command" is:
if [[ $# -eq 0 ]]; then
    COMMAND="run"
else
    COMMAND="$1"
fi

function print_help() {
    cat <<EOF
Usage: $0 <command> [args...]

Purpose:
  This script is the *WorkSpace Wrapper*.
  - It is meant to be small and stable, living in the WorkSpaceWrapper project.
  - It does NOT auto-update itself.
  - It downloads, verifies and runs the actual WorkSpace script
    (.workspace/tools/workspace.sh) from the WorkSpace project.
  - This allows workspace.sh to evolve independently, while the Wrapper
    remains a reliable, stable entry point for users.

Wrapper commands:
  update [VERSION]   Download or update .workspace/tools/workspace.sh
  run [ARGS...]      Run workspace.sh with ARGS (after integrity checks)
  version            Show this Wrapper's version
  help               Show this help message

Notes:
  - workspace.sh.sha256 and workspace.sh.meta are expected in .workspace/tools
  - Set VERBOSE=true for extra logs during update.
EOF
}

case "${COMMAND}" in
    version)
        cat <<'EOF'
__      __       _    ___                    __      __                           
\ \    / /__ _ _| |__/ __|_ __  __ _ __ ___  \ \    / / _ __ _ _ __ _ __  ___ _ _ 
 \ \/\/ / _ \ '_| / /\__ \ '_ \/ _` / _/ -_)  \ \/\/ / '_/ _` | '_ \ '_ \/ -_) '_|
  \_/\_/\___/_| |_\_\|___/ .__/\__,_\__\___|   \_/\_/|_| \__,_| .__/ .__/\___|_|  
                         |_|                                  |_|  |_|            

EOF
        echo "WorkSpace Wrapper: $VERSION"
        PRFX="WorkSpace        "
        TOOL=".workspace/tools/workspace.sh"

        if [[ ! -f "$TOOL" ]]; then
            echo "${PRFX}: uninstalled"
            exit 0
        fi

        if [[ ! -x "$TOOL" ]]; then chmod +x "$TOOL" 2>/dev/null || true; fi

        TOOL_VERSION=$("$TOOL" ws-version 2>/dev/null || echo "")

        if [[ -z "$TOOL_VERSION" ]]; then
            echo "${PRFX}: installed (version unknown)"
        else
            echo "$TOOL_VERSION"
        fi
        exit 0
        ;;
    help)
        print_help
        exit 0
        ;;
esac

# Need curl for update/run
if ! command -v curl >/dev/null 2>&1; then
    echo "curl does not exist."
    exit 1
fi

function DownloadWorkspace() {
    WS_VERSION=${1:-latest}
    local tmpfile tmpsha256 expected_sha256 actual_sha256 dest dest_dir sha_file meta_file actual_version

    tmpfile=$(mktemp "/tmp/workspace.sh.XXXXXX")
    tmpsha256=$(mktemp "/tmp/workspace.sh.sha256.XXXXXX")

    REPO_URL="https://github.com/NawaMan/WorkSpace"
    DWLD_URL="${REPO_URL}/releases/download"
    TOOL_URL="${DWLD_URL}/${WS_VERSION}/workspace.sh"
    SHA256_URL="${DWLD_URL}/${WS_VERSION}/workspace.sh.sha256"

    # Download script
    if ! curl -fsSLo "$tmpfile" "$TOOL_URL"; then
        echo "Error: Failed to download workspace.sh from ${TOOL_URL}" >&2
        rm -f "$tmpfile" "$tmpsha256"
        return 1
    fi

    # Download SHA256 file
    if ! curl -fsSLo "$tmpsha256" "$SHA256_URL"; then
        echo "Error: Failed to download workspace.sh.sha256 from ${SHA256_URL}" >&2
        rm -f "$tmpfile" "$tmpsha256"
        return 1
    fi

    # Read expected SHA256
    expected_sha256=$(awk '{print $1}' "$tmpsha256")

    # Validate SHA256 format (64 hex chars)
    if ! [[ "$expected_sha256" =~ ^[0-9a-fA-F]{64}$ ]]; then
        echo "Error: SHA256 file is malformed (got '$expected_sha256')" >&2
        rm -f "$tmpfile" "$tmpsha256"
        return 1
    fi

    # Compute actual hash
    actual_sha256=$(sha256sum "$tmpfile" | awk '{print $1}')

    if [[ "$expected_sha256" != "$actual_sha256" ]]; then
        echo "Error: SHA256 mismatch for workspace.sh" >&2
        echo "  Expected: $expected_sha256" >&2
        echo "  Actual:   $actual_sha256" >&2
        rm -f "$tmpfile" "$tmpsha256"
        return 1
    fi

    # Determine version from downloaded file
    chmod +x "$tmpfile"
    actual_version=$("$tmpfile" ws-version 2>/dev/null || echo "")

    if [[ -z "$actual_version" ]]; then
        echo "Error: Could not determine version from workspace.sh" >&2
        rm -f "$tmpfile" "$tmpsha256"
        return 1
    fi

    # Install locations
    dest=".workspace/tools/workspace.sh"
    dest_dir="$(dirname "$dest")"
    sha_file="$dest_dir/workspace.sh.sha256"
    meta_file="$dest_dir/workspace.sh.meta"

    mkdir -p "$dest_dir"

    mv -f "$tmpfile" "$dest"
    chmod +x "$dest"

    # Save local checksum
    printf '%s  %s\n' "$actual_sha256" "workspace.sh" > "$sha_file"

    # Write metadata
    {
        echo "version=${actual_version}"
        echo "url=${TOOL_URL}"
        echo "sha256=${actual_sha256}"
        echo "downloaded_at=$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
    } > "$meta_file"

    touch "$dest"

    if [[ "${VERBOSE}" == "false" ]]; then
        echo "workspace.sh downloaded, verified (SHA256), and installed."
        echo "Workspace written to: $dest"
        echo "Metadata  written to: $meta_file"
        echo "Digest    written to: $sha_file"
        echo "Actual version: ${actual_version}"
        echo ""
        echo "You can now rerun: ./workspace"
    fi

    rm -f "$tmpsha256"
}

### --- COMMAND DISPATCH --- ###
case "${COMMAND}" in
    install|update)
        WS_VERSION="${2:-latest}"
        DownloadWorkspace "${WS_VERSION}"
        exit 0
        ;;
    run)
        if [[ "${1-}" == "run" ]]; then shift; fi
        ;;
    *)
        ;;
esac

### --- RUN MODE --- ###
dest=".workspace/tools/workspace.sh"
tools_dir=".workspace/tools"
sha_file="$tools_dir/workspace.sh.sha256"
meta_file="$tools_dir/workspace.sh.meta"

# Required files existence
if [[ ! -f "$dest" || ! -f "$sha_file" || ! -f "$meta_file" ]]; then
    echo "WorkSpace is not installed correctly."
    echo "Please run: $0 install"
    exit 1
fi

# Ensure workspace.sh is newer than checksum
if [[ "$dest" -ot "$sha_file" ]]; then
    echo "workspace.sh appears older than its checksum file."
    echo "Please run: $0 update"
    exit 1
fi

# Verify SHA256
if ! (cd "$tools_dir" && sha256sum -c "workspace.sh.sha256" >/dev/null); then
    echo "Local workspace.sh failed SHA256 verification."
    echo "Please run: $0 update"
    exit 1
fi

exec "$dest" "$@"
